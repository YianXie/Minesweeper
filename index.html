<!DOCTYPE html>
<html>
    <head>
        <title>扫雷</title>
        <style>
            /* Css Style */
            body {
                position: fixed;
                left: 26.5%;
                top: 10%;
            }

            #bigtitle {
                position: fixed;
                left: 47%;
                top: 0%;
            }

            table td {
                width: 70px;
                height: 70px;
                text-align: center;
                background-color: rgb(189, 189, 189);
                font-family: monospace;
                box-shadow: 3px 3px 0 0 rgb(123, 123, 123);
                font-weight: bold;
                background-size: 60px 60px;
                background-position: center;
                background-repeat: no-repeat;
            }

            button {
                width: 70px;
                height: 70px;
                background-color: transparent;
                border: none;
                
            }

            .minesweeper {
                margin: 0 auto;
            }

            #left_flag_number {
                position: fixed;
                left: 27%;
                top: 2%;
            }

            #total_used_time {
                position: fixed;
                left: 71.5%;
                top: 2%;
            }

            .flag_mode_div {
                position: fixed;
                left: 75%;
                top: 4.6%;
            }

            #flag_mode {
                width: 20px;
                height: 20px;
            }

            #flag_mode_label {
                position: fixed;
                font-size: large;
                margin-left: 5px;
            }
        </style>
    </head>
    <body>
        <h1 id="bigtitle">Minesweeper</h1>
        <h3 id="left_flag_number"></h3>
        <h3 id="total_used_time">0</h3>
        <audio id="lose_audio">
            <source src="bomb_explosion.mp3" type="audio/mpeg">
        </audio>
        <audio id="click_audio">
            <source src="Minesweeper_Click.mp3" type="audio/mpeg">
        </audio>
        <table class="minesweeper" id="minesweeper_table">
            <!-- Main Game -->
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)" contextmenu=""><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <tr onclick="click_row(this)">
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
                <td onclick="click_column(this)"><button></button></td>
            </tr>
            <div class="flag_mode_div">
                <input type="checkbox" value="flag_mode" name="flag_mode" onchange="flag_mode_function()" id="flag_mode">
                <label for="flag_mode" id="flag_mode_label"> Flag Mode</label>
            </div>
        </table>
        <script>
            // Variables
            var landmine_coor = [];
            var click_row_number = 0;
            var click_column_number = 0;
            var minesweeper_table = document.getElementById("minesweeper_table");
            var changed_value;
            var left_flag = 8;
            var td_cells = document.querySelectorAll("td");
            var tr_cells = document.querySelectorAll("tr");
            var total_time = 0;
            var win_percentage = 1;
            var tr_cell;
            var enable_flag_mode_or_not = false;
            var first_click = true;
            var map = [
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0]
            ];
            var expanded = [
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0]
            ];
            var map_size = 9;
            var landmine_count = 8;

            document.getElementById("left_flag_number").innerHTML = left_flag + " more flag(s)"

            setInterval(update_time,1000);

            function flag_mode_function() {
                enable_flag_mode_or_not = document.getElementById("flag_mode").checked;
            };

            function update_time() {
                total_time += 1;
                document.getElementById("total_used_time").innerHTML = total_time;
            };

            function init(click_row_number,click_column_number) {
                for (let i=0;i<landmine_count;i++) {
                    // Get the landmine coords
                    let random_row = Math.floor(Math.random() * landmine_count); // Random row
                    let random_column = Math.floor(Math.random() * landmine_count); // Random col
                    random_row = random_row.toString();
                    random_column = random_column.toString();
                    let added_value = random_row + random_column;
                    // Prevent same number from appearing
                    if (landmine_coor.includes(added_value) || added_value == (click_row_number.toString() + click_column_number.toString())) {
                        i -= 1;
                        continue;
                    } else {
                        landmine_coor.push(added_value);
                        map[random_row][random_column] = 9;
                    }; 
                }; 
                
                for (let r = 0;r < map_size;r++) {
                    for (let c = 0;c < map_size;c++) {
                        var landmine_beside = 0;
                        if (map[r][c] != 9) {
                            if (r-1 >= 0 && c-1 >= 0 ) {
                                if (map[r-1][c-1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r-1 >= 0) {
                                if (map[r-1][c] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r-1 >= 0 && c+1 <= map_size-1 ) {
                                if (map[r-1][c+1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (c-1 >= 0 ) {
                                if (map[r][c-1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (c+1 <= map_size-1 ) {
                                if (map[r][c+1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r+1 <= map_size-1 && c-1 >= 0 ) {
                                if (map[r+1][c-1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r+1 <= map_size-1) {
                                if (map[r+1][c] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r+1 <= map_size-1 && c+1 <= map_size-1) {
                                if (map[r+1][c+1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            map[r][c] = landmine_beside;
                        }
                    }
                }
            }

            function click_row(row) {
                // Get the row number
                click_row_number = row.rowIndex;
                if (first_click) {
                    init(click_row_number,click_column_number);
                }; 
                check_landmine(click_row_number,click_column_number);
                if (map[click_row_number][click_column_number] == 0) {
                    expand_cell(click_row_number,click_column_number);
                }
                first_click = false;
            };

            function click_column(cell) {
                // Get the cell number
                click_column_number = cell.cellIndex;
            };

            function expand_cell(row,col) {
                expanded[row][col] = 1;
                if (!landmine_coor.includes(row.toString() + col.toString()) && check_if_there_are_landmine_beside(row,col)) {
                    if (row-1 >= 0 && col-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row-1)).toString() + parseInt(col -1).toString())) {
                            check_landmine(row-1,col-1);
                            if (map[row-1][col-1] == 0 && expanded[row-1][col-1] == 0) {
                                expand_cell(row-1,col-1);
                            };
                        }
                    } 
                    if (row-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row-1)).toString() + parseInt(col).toString())) {
                            check_landmine(row-1,col);
                            if (map[row-1][col] == 0 && expanded[row-1][col] == 0) {
                                expand_cell(row-1,col);
                            };
                        } 
                    } 
                    if (row-1 >= 0 && col+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row-1)).toString() + parseInt(col + 1).toString())) {
                            check_landmine(row-1,col+1);
                            if (map[row-1][col+1] == 0 && expanded[row-1][col+1] == 0) {
                                expand_cell(row-1,col+1);
                            };
                        } 
                    }
                    // 旗子还没有考虑
                    if (col-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row)).toString() + parseInt(col - 1).toString())) {
                            check_landmine(row,col-1);
                            if (map[row][col-1] == 0 && expanded[row][col-1] == 0) {
                                expand_cell(row,col-1);
                            };
                        }
                    } 
                    if (col+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row)).toString() + parseInt(col + 1).toString())) {
                            check_landmine(row,col+1);
                            if (map[row][col+1] == 0 && expanded[row][col+1] == 0) {
                               expand_cell(row,col+1);
                            };
                        } 
                    }
                    if (row+1 <= map_size-1 && col-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row+1)).toString() + parseInt(col - 1).toString())) {
                            check_landmine(row+1,col-1);
                            if (map[row+1][col-1] == 0 && expanded[row+1][col-1] == 0) {
                                expand_cell(row+1,col-1);
                            };
                        } 
                    }
                    if (row+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row+1)).toString() + parseInt(col).toString())) {
                            check_landmine(row+1,col);
                            if (map[row+1][col] == 0 && expanded[row+1][col] == 0) {
                                expand_cell(row+1,col);
                            };
                        } 
                    }
                    if (row+1 <= map_size-1 && col+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row+1)).toString() + parseInt(col + 1).toString())) {
                            check_landmine(row+1,col+1);
                            if (map[row+1][col+1] == 0 && expanded[row+1][col+1] == 0) {
                                expand_cell(row+1,col+1);
                            };
                        } 
                    };
                } 
            }

            function check_if_there_are_landmine_beside(row,col) {
                if (landmine_coor.includes(row.toString() + col.toString()) == false) {
                    if (landmine_coor.includes((parseInt(row) - 1).toString() + parseInt(col -1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) - 1).toString() + parseInt(col).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) + 1).toString() + parseInt(col - 1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) + 1).toString() + parseInt(col + 1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) + 1).toString() + parseInt(col).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row)).toString() + parseInt(col - 1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row)).toString() + parseInt(col + 1).toString())) {
                        return false;
                    } else {
                        return true;
                    };
                } else {
                    return false;
                };
            };

            function check_landmine(click_row_number,click_column_number) {
                if (enable_flag_mode_or_not) {
                    var cell = minesweeper_table.rows[click_row_number].cells[click_column_number];
                    var landmine_coor_copy = [...landmine_coor]; // Copy the array to avoid modifying it during iteration
                    var allLandminesFlagged = true;
                    for (let x = 0; x < landmine_coor_copy.length; x++) {
                        const split_value = landmine_coor_copy[x].split("");
                        const landmineCell = minesweeper_table.rows[split_value[0]].cells[split_value[1]];
                        
                        if (landmineCell.style.backgroundColor === "yellow") {
                            landmine_coor_copy.splice(x, 1);
                            x--; // Adjust the index to account for the removed element
                        } else {
                            allLandminesFlagged = false;
                        }
                    }

                    if (!allLandminesFlagged || landmine_coor_copy.length !== 0) {
                        if (left_flag > 0 && cell.style.backgroundColor !== "yellow") {
                            left_flag -= 1;
                            cell.style.backgroundColor = "yellow"; // Yellow represents flag in Minesweeper
                            document.getElementById("left_flag_number").innerHTML = left_flag + " more flag(s)";
                        } else if (left_flag <= 0) {
                            alert("No more flags!");
                        };
                    } else {
                        alert("You Won!");
                        console.log("You won!");
                    };
                } else {
                    var landmine_number = 0;
                    changed_value = minesweeper_table.rows[click_row_number].cells[click_column_number];
                    if (landmine_coor.includes(click_row_number.toString() + "" + click_column_number.toString())) {
                        // If the player click on the landmine...
                        changed_value.style.backgroundImage = "url('Minesweeper_Icon_Bomb.png')";
                        changed_value.style.backgroundColor = "red";
                        for (let i = 0;i < landmine_coor.length;i++) {
                            var show_all_landmine = landmine_coor[i].split("");
                            minesweeper_table.rows[show_all_landmine[0]].cells[show_all_landmine[1]].style.backgroundImage = "url('Minesweeper_Icon_Bomb.png')";
                        };
                        document.getElementById("lose_audio").play();
                        console.log("You Lose");
                    } else if (minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundImage.includes("Minesweeper_Flag_Icon.png")) {
                        left_flag += 1;
                        document.getElementById("left_flag_number").innerHTML = left_flag + " more flag(s)"
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundColor = "rgb(189,189,189)";
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundImage = "none";
                    } else {
                        document.getElementById("click_audio").play();
                        if (map[click_row_number][click_column_number] != 0) {
                            minesweeper_table.rows[click_row_number].cells[click_column_number].innerHTML = map[click_row_number][click_column_number];
                            minesweeper_table.rows[click_row_number].cells[click_column_number].style.fontSize = "50px";
                            minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundColor = "white";
                            minesweeper_table.rows[click_row_number].cells[click_column_number].style.border = "solid";
                        } else {
                            minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundColor = "white";
                            minesweeper_table.rows[click_row_number].cells[click_column_number].style.border = "solid";
                        }
                    };

                        // Change the color of the number depend on the value
                    var number_on_the_cell = minesweeper_table.rows[click_row_number].cells[click_column_number].innerHTML;
                    if (number_on_the_cell == 1) {
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "blue";
                    } else if (number_on_the_cell == 2) {
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "green";
                    } else if (number_on_the_cell == 3) {
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "red";
                    } else if (number_on_the_cell == 4) {
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "purple";
                    } else if (number_on_the_cell >= 5) {
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "black";
                    };
                };
            };

            td_cells.forEach(cell => {
                cell.addEventListener("contextmenu", function(event) {
                    event.preventDefault(); // Prevent user from getting right-click information
                    var landmine_coor_copy = [...landmine_coor]; // Copy the array to avoid modifying it during iteration
                    var allLandminesFlagged = true;
                    for (let x = 0; x < landmine_coor_copy.length; x++) {
                        const split_value = landmine_coor_copy[x].split("");
                        const landmineCell = minesweeper_table.rows[split_value[0]].cells[split_value[1]];
                        if (landmineCell.style.backgroundImage == "url('Minesweeper_Flag_Icon.png')") {
                            landmine_coor_copy.splice(x, 1);
                            x--; // Adjust the index to account for the removed element
                        } else {
                            allLandminesFlagged = false;
                        }
                    }

                    if (!first_click) {
                        if (!allLandminesFlagged || landmine_coor_copy.length !== 0) {
                            if (left_flag > 0 && cell.style.backgroundColor !== "yellow") {
                            left_flag -= 1;
                            cell.style.backgroundImage = "url('Minesweeper_Flag_Icon.png')"; 
                            document.getElementById("left_flag_number").innerHTML = left_flag + " more flags";
                            // flagged[][cell.cellIndex] = 1;
                            } else if (left_flag <= 0) {
                                alert("No more flags!");
                            };
                        } else {
                            alert("You Won!");
                        };
                    };
                });
            });
        </script>
    </body>
</html>
